<!-- Version 1 -->

{% extends "base.html" %}
{% block content %}

<!-- Organiser: Create Event -->
<div class="row" style="align-items:flex-start; gap:18px">
  <!-- LEFT COLUMN: Main event creation form -->
  <div class="grow">
    <div class="card" style="padding-bottom:10px">
      <h2 style="margin:0 0 6px">Create a New Event</h2>
      <p class="muted" style="margin:0 0 12px">Add the key details, ticket price, and how funds are allocated.</p>

      <!-- Flask-WTF form (CSRF included via hidden_tag) -->
      <!-- Reference: Flask-WTF form rendering, CSRF, and hidden_tag (Pallets Projects, 2024)
      https://flask-wtf.readthedocs.io/en/1.2.x/quickstart/
      https://flask-wtf.readthedocs.io/en/1.2.x/form/
      https://flask-wtf.readthedocs.io/en/1.2.x/csrf/ -->
      <!-- VERSION 5 START -->
      <form method="post" novalidate enctype="multipart/form-data">
      <!-- VERSION 5 START -->
        {{ form.hidden_tag() }}

        <!-- Selection: Event basics -->
        <h3 style="margin:6px 0 8px">Event Details</h3>

        <!-- Title -->
        <label for="{{ form.title.id }}">Title</label>
        {{ form.title(class="", placeholder="e.g. Cork Christmas Fundraiser") }}
        {% for e in form.title.errors %}
          <div class="flash danger">{{ e }}</div>
        {% endfor %}

        <!-- Description -->
        <label for="{{ form.description.id }}">Description</label>
        {{ form.description(class="", rows="4", placeholder="What’s the event about?") }}
        {% for e in form.description.errors %}
          <div class="flash danger">{{ e }}</div>
        {% endfor %}

        <!-- VERSION 3 START -->
        <!-- Row containing the AI description button and status text -->
        <div class="row" style="gap:10px; margin-top:10px">
          <!-- Button to trigger AI-generated event description -->
          <button type="button" class="btn outline" id="btn-ai-desc">
            Suggest description
          </button>
          <!-- Status text showing AI state (thinking / done / error) -->
          <span class="muted" id="ai-status" style="align-self:center"></span>
        </div>

        <!-- Reference: ChatGPT JavaScript code -->
        <!-- https://chatgpt.com/share/69736e29-4d08-8004-a8ff-71f40f533a51 -->
        <script>
          // Read the CSRF token from the meta tag so POST requests are accepted by Flask
          const csrfToken = document
            .querySelector('meta[name="csrf-token"]')
            .getAttribute('content');

          // Collect all relevant form values to send to the AI endpoint
          function collectPayload() {
            // Basic event fields
            const title = document.querySelector('input[name="title"]')?.value || "";
            const venue = document.querySelector('input[name="venue"]')?.value || "";
            const starts_at = document.querySelector('input[name="starts_at"]')?.value || "";
            const ticket_price = document.querySelector('input[name="ticket_price_eur"]')?.value || "";

            // Select all beneficiary dropdowns and percentage inputs
            const benSelects = document.querySelectorAll('select[name^="beneficiaries-"][name$="-charity_id"]');
            const benPcts = document.querySelectorAll('input[name^="beneficiaries-"][name$="-allocation_percent"]');

            // Build an array of beneficiary names and allocation percentages
            const beneficiaries = [];
            for (let i = 0; i < benSelects.length; i++) {
              const name = benSelects[i]?.selectedOptions?.[0]?.text || "";
              const pct = benPcts[i]?.value ? parseInt(benPcts[i].value, 10) : null;
              if (name) beneficiaries.push({ name, pct });
            }

            // Return the payload object expected by the Flask AI route
            return { title, venue, starts_at, ticket_price, beneficiaries };
          }

          // Call the AI endpoint and optionally fill the description textarea
          async function callAI(url, fillDescription=false) {
            const status = document.getElementById('ai-status');
            // Show loading state to the user
            status.textContent = "Thinking…";

            // Send POST request to the AI route
            const res = await fetch(url, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
              },
              body: JSON.stringify(collectPayload())
            });

            // Parse the JSON response
            const data = await res.json();

            // Handle error response from the server or AI
            if (!data.ok) {
              status.textContent = "Error";
              out.textContent = data.error || "Something went wrong.";
              return;
            }

            // Update status once AI processing is complete
            status.textContent = "Done";

            // Insert the AI-generated text into the description field
            const ta = document.querySelector('textarea[name="description"]');
            if (ta && data.text) ta.value = data.text.trim();
          }

          // Trigger AI description generation when the button is clicked
          document
            .getElementById('btn-ai-desc')
            .addEventListener('click', () => {
              callAI("{{ url_for('main.ai_event_description') }}", true);
            });
        </script>

        <!-- VERSION 3 END -->

        <!-- Venue + Start datetime -->
        <div class="row" style="gap:12px; margin-top:8px">
          <div style="flex:1">
            <label for="{{ form.venue.id }}">Venue</label>
            {{ form.venue(class="", placeholder="e.g. City Hall, Cork") }}
            {% for e in form.venue.errors %}
              <div class="flash danger">{{ e }}</div>
            {% endfor %}
          </div>
          <div style="flex:1">
            <label for="{{ form.starts_at.id }}">Starts At</label>
            <!-- Uses HTML5 datetime-local; server will parse/validate -->
            <!-- Reference: HTML input type "datetime-local" (MDN, 2024)
            https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/datetime-local -->
            {{ form.starts_at(class="", type="datetime-local") }}
            {% for e in form.starts_at.errors %}
              <div class="flash danger">{{ e }}</div>
            {% endfor %}
          </div>
        </div>

        <!-- Price + Publish toggle -->
        <div class="row" style="gap:12px; margin-top:8px">
          <div style="flex:1">
            <label for="{{ form.ticket_price_eur.id }}">Ticket Price (€)</label>
            {{ form.ticket_price_eur(class="", placeholder="e.g. 15.00") }}
            {% for e in form.ticket_price_eur.errors %}
              <div class="flash danger">{{ e }}</div>
            {% endfor %}
          </div>
          <!-- Simple publish-now checkbox (server decides draft vs published) -->
          <div style="flex:1; display:flex; align-items:end">
            <label class="row" style="gap:10px; align-items:center; margin:0">
              <span>Publish immediately?</span>
              {{ form.published(class="") }}
            </label>
          </div>
        </div>

        <!-- VERSION 5 START -->
        <label for="{{ form.cover_image.id }}">Event Image (optional)</label>
        <p class="muted" style="margin:-4px 0 8px; font-size:.85rem;">Upload a JPG or PNG. If left blank, a branded banner will be shown.</p>
        {{ form.cover_image(class="") }}
        {% for e in form.cover_image.errors %}
          <div class="flash danger">{{ e }}</div>
        {% endfor %}
        <!-- VERSION 5 END -->

        <hr style="margin:16px 0; border:none; border-top:1px solid var(--line)">

        <!-- Section: Beneficiaries & Allocations -->
        <div class="row space-between" style="align-items:center">
          <h3 style="margin:0">Beneficiaries</h3>
          <div class="row" style="gap:10px; align-items:center">
            <!-- Reminder: validation rule (sum must be 100%) -->
            <span class="badge" style="font-weight:700">Total must equal 100%</span>
            <!-- “Add Beneficiary” submits form without validation to append another subform row. The view should detect 'add_beneficiary' and re-render with an extra entry. -->
             <!-- Reference: HTML form attribute 'formnovalidate' (MDN, 2024)
            https://developer.mozilla.org/en-US/docs/Web/HTML/Element/button#attr-formnovalidate -->
            <button class="btn outline" name="add_beneficiary" value="1" formnovalidate type="submit">+ Add Beneficiary</button>
          </div>
        </div>
        <p class="muted" style="margin:6px 0 12px">
          Allocations must add up to <strong>100%</strong>. The system will validate this when you submit.
        </p>

        <!-- FieldList of beneficiary subforms: charity selector + % allocation -->
        <!-- Reference: Jinja for-loop & form field rendering (Pallets Projects, 2024; WTForms, 2024)
        https://jinja.palletsprojects.com/en/stable/templates/#for
        https://wtforms.readthedocs.io/en/stable/crash_course/#rendering-fields -->
        <div class="vstack" style="display:flex; flex-direction:column; gap:10px">
          {% for b in form.beneficiaries %}
            <div class="row" style="gap:12px; border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:#fff">
              <div class="grow">
                <label for="{{ b.charity_id.id }}">Charity</label>
                {{ b.charity_id(class="") }}
                {% for e in b.charity_id.errors %}
                  <div class="flash danger">{{ e }}</div>
                {% endfor %}
              </div>
              <div style="width:160px">
                <label for="{{ b.allocation_percent.id }}">% Allocation</label>
                {{ b.allocation_percent(class="", placeholder="e.g. 50") }}
                {% for e in b.allocation_percent.errors %}
                  <div class="flash danger">{{ e }}</div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
    
        <!-- Global form errors (e.g., CSRF issues; allocation sum != 100 handled in view/form validators) -->
        <!-- Reference: Flask-WTF CSRF error reporting (Pallets Projects, 2024)
        https://flask-wtf.readthedocs.io/en/1.2.x/csrf/ -->
        {% if form.csrf_token.errors %}
          {% for e in form.csrf_token.errors %}<div class="flash danger">{{ e }}</div>{% endfor %}
        {% endif %}

        <!-- Actions: Cancel or Submit (server will create draft/published based on checkbox) -->
        <div class="row" style="justify-content:flex-end; gap:10px; margin-top:16px">
          <!-- Reference: Flask url_for (Pallets Projects, 2024)
          https://flask.palletsprojects.com/en/stable/quickstart/#url-building -->
          <a class="btn" href="{{ url_for('main.index') }}">Cancel</a>
          {{ form.submit(class="btn primary") }}
        </div>
      </form>
    </div>
  </div>

  <!-- RIGHT COLUMN: Static preview/tips -->
  <aside style="width:340px; max-width:100%">
    <div class="card ticket">
      <div class="row space-between">
        <strong>Event Preview</strong>
        <span class="badge">Draft</span>
      </div>
      <!-- Lightweight, read-only hints reflecting current inputs where possible -->
      <div style="margin-top:10px">
        <!-- Ticket price preview (falls back to €0.00 if empty) -->
        <div class="row space-between">
          <span>Ticket price</span>
          <!-- Show current input value if bound back by WTForms after POST, else placeholder -->
          <strong>
            {% if form.ticket_price_eur.data %}
              €{{ '%.2f' % (form.ticket_price_eur.data | float) }}
            {% else %}
              €0.00
            {% endif %}
          </strong>
        </div>
         <!-- Allocation total: not calculated here (no JS); enforced on submit -->
        <div class="row space-between" style="margin-top:6px">
          <span>Allocation total</span>
          <strong>—</strong>
        </div>
      </div>
      <hr style="margin:12px 0; border:none; border-top:1px solid var(--line)">
      <!-- Authoring tip for organisers -->
      <div class="muted" style="font-size:.9rem">
        Tip: keep descriptions short (2–4 lines), and add a clear venue + start time.
        You can publish now or save as draft.
      </div>
    </div>
  </aside>
</div>

{% endblock %}

<!-- Version 1 -->
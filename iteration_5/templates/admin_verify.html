<!-- Version 1 -->

{% extends "base.html" %}
{% block content %}

<!-- Page Heading and Description -->
<!-- Reference: Jinja control structures (Pallets Projects, 2024)
https://jinja.palletsprojects.com/en/stable/templates/#list-of-control-structures -->
<!-- VERSION 5 START -->
<div class="row space-between" style="align-items:flex-end; gap:16px; margin-bottom:20px">
  <div>
    <h2 style="margin:0 0 6px">Admin &mdash; Verify Organisers &amp; Charities</h2>
    <p class="muted" style="margin:0">
      Approve, reject, or move applications back to pending. Verified organisers can publish events and verified charities can be selected as beneficiaries.
    </p>
  </div>
  <a class="btn" href="{{ url_for('main.admin_home') }}">Back to Admin</a>
</div>
<!-- VERSION 5 END -->

<!-- Main container card -->
<div class="card">
  <!-- Reference: Jinja tests & filters (Pallets Projects, 2024)
  https://jinja.palletsprojects.com/en/stable/templates/#tests -->
  {% if orgs and orgs|length > 0 %}
    <!-- Summary Row -->
    <div class="row" style="margin-bottom:10px; gap:10px; align-items:center">
      <span class="badge"><strong>{{ orgs|length }}</strong> total</span>
    </div>

    <!-- Table displaying organiser records -->
    <!-- Reference: MDN HTML tables & structure (MDN, 2024)
    https://developer.mozilla.org/en-US/docs/Learn/HTML/Tables/Basics -->
    <!-- Reference: MDN accessibility patterns (MDN, 2024)
    https://developer.mozilla.org/en-US/docs/Learn/Accessibility/HTML -->
    <div style="overflow-x:auto">
      <table style="width:100%; border-collapse:separate; border-spacing:0 8px">
        <thead>
          <tr style="text-align:left; color:var(--muted); font-size:.9rem">
            <th style="padding:8px 10px">Organisation</th>
            <th style="padding:8px 10px">Email</th>
            <th style="padding:8px 10px">Charity No.</th>
            <th style="padding:8px 10px">Status</th>
            <th style="padding:8px 10px" class="text-right">Action</th>
          </tr>
        </thead>
        <tbody>

          <!-- Loop through organiser objects passed from Flask view -->
          <!-- Reference: Jinja for-loop (Pallets Projects, 2024)
          https://jinja.palletsprojects.com/en/stable/templates/#for -->
          {% for org in orgs %}
          <tr class="card" style="padding:0">
            <!-- Organisation name (fallback if null) -->
            <td style="padding:12px 10px"><strong>{{ org.organisation_name or 'Unnamed organisation' }}</strong></td>
            <!-- Linked user email (if organiser has associated user account) -->
            <td style="padding:12px 10px">{{ org.contact_email or (org.user.email if org.user else '—') }}</td>
            <!-- Charity registration number (optional field) -->
            <td style="padding:12px 10px">{{ org.charity_number or '—' }}</td>
            <!-- Verification status badge -->
            <!-- Reference: Jinja if/else (Pallets Projects, 2024)
            https://jinja.palletsprojects.com/en/stable/templates/#if -->
            <td style="padding:12px 10px">
              {% if org.status == 'verified' %}
                <!-- Green badge = verified -->
                <span class="badge" style="color:#065f46; border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.08)">
                  Verified
                </span>
              <!-- VERSION 2 START -->
              {% elif org.status == 'rejected' %}
                <!-- Amber badge = rejected -->
                <span class="badge" style="color:#7c2d12; border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.12)">
                  Rejected
                </span>
              <!-- VERSION 2 END -->
              {% else %}
                <!-- Grey badge = pending -->
                <span class="badge" style="color:#334155; border-color:rgba(148,163,184,.45); background:rgba(148,163,184,.12)">
                  Pending
                </span>
              {% endif %}
            </td>
            <!-- VERSION 2 START -->
            <!-- Action column with verification toggle form -->
            <td style="padding:12px 10px" class="text-right">
              <div class="row" style="gap:8px; justify-content:flex-end">
                <!-- Pending organisers: admin can verify or reject -->
                {% if org.status == 'pending' %}
                  <!-- Reference: Flask url_for (Pallets Projects, 2024)
                  https://flask.palletsprojects.com/en/stable/quickstart/#url-building -->
                  <form method="post" action="{{ url_for('main.admin_verify_action', org_id=org.id) }}">
                    <!-- CSRF token for security (Flask-WTF integration) -->
                    <!-- Reference: Flask-WTF CSRF token in forms (Pallets Projects, 2024)
                    https://flask-wtf.readthedocs.io/en/1.2.x/csrf/ -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="verify">
                    <button type="submit" class="btn success">Verify</button>
                  </form>
                  <form method="post" action="{{ url_for('main.admin_verify_action', org_id=org.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="reject">
                    <button type="submit" class="btn danger-outline">Reject</button>
                  </form>
                <!-- Verified organisers: admin can remove verification -->
                {% elif org.status == 'verified' %}
                  <form method="post" action="{{ url_for('main.admin_verify_action', org_id=org.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="unverify">
                    <button type="submit" class="btn danger-outline">Unverify</button>
                  </form>
                <!-- Rejected organisers: admin can reset them back to pending -->
                {% elif org.status == 'rejected' %}
                  <form method="post" action="{{ url_for('main.admin_verify_action', org_id=org.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="restore">
                    <button type="submit" class="btn outline">Restore to pending</button>
                  </form>
                {% endif %}
              </div>
            </td>
          </tr>
          <!-- VERSION 2 END -->
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <!-- Message shown if there are no organisers to verify -->
    <div class="flash info">No organisers found.</div>
  {% endif %}
</div>

<!-- VERSION 2 START -->
<!-- Container card for displaying all charities -->
<div class="card" style="margin-top:16px">
  <h3 style="margin:0 0 10px">Charities</h3>

  {% if charities and charities|length > 0 %}
    <!-- Summary row showing total number of charities -->
    <div class="row" style="margin-bottom:10px; gap:10px; align-items:center">
      <span class="badge"><strong>{{ charities|length }}</strong> total</span>
    </div>
    <!-- Table wrapper with horizontal scroll for smaller screens -->
    <div style="overflow-x:auto">
      <table style="width:100%; border-collapse:separate; border-spacing:0 8px">
        <thead>
          <!-- Column headers -->
          <tr style="text-align:left; color:var(--muted); font-size:.9rem">
            <th style="padding:8px 10px">Charity</th>
            <th style="padding:8px 10px">Email</th>
            <th style="padding:8px 10px">Charity No.</th>
            <th style="padding:8px 10px">Status</th>
            <th style="padding:8px 10px" class="text-right">Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Loop through each charity and display details -->
          {% for ch in charities %}
          <tr class="card" style="padding:0">
            <!-- Charity name -->
            <td style="padding:12px 10px"><strong>{{ ch.name or 'Unnamed charity' }}</strong></td>
            <!-- Charity contact email -->
            <td style="padding:12px 10px">{{ ch.contact_email or '—' }}</td>
            <!-- Charity registration number -->
            <td style="padding:12px 10px">{{ ch.charity_number or '—' }}</td>
            <!-- Charity verification status -->
            <td style="padding:12px 10px">
              {% if ch.status == 'verified' %}
                <!-- Verified badge -->
                <span class="badge" style="color:#065f46; border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.08)">
                  Verified
                </span>
              {% elif ch.status == 'rejected' %}
                <!-- Rejected badge -->
                <span class="badge" style="color:#7c2d12; border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.12)">
                  Rejected
                </span>
              {% else %}
                <!-- Pending badge -->
                <span class="badge" style="color:#334155; border-color:rgba(148,163,184,.45); background:rgba(148,163,184,.12)">
                  Pending
                </span>
              {% endif %}
            </td>
            <!-- Action buttons: depends on current status -->
            <td style="padding:12px 10px" class="text-right">
              <div class="row" style="gap:8px; justify-content:flex-end">
                {% if ch.status == 'pending' %}
                  <!-- Approve charity -->
                  <form method="post" action="{{ url_for('main.admin_verify_charity_action', charity_id=ch.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="verify">
                    <button type="submit" class="btn success">Verify</button>
                  </form>
                  <!-- Reject charity -->
                  <form method="post" action="{{ url_for('main.admin_verify_charity_action', charity_id=ch.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="reject">
                    <button type="submit" class="btn danger-outline">Reject</button>
                  </form>
                {% elif ch.status == 'verified' %}
                  <!-- Move charity back to pending/unverified -->
                  <form method="post" action="{{ url_for('main.admin_verify_charity_action', charity_id=ch.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="unverify">
                    <button type="submit" class="btn danger-outline">Unverify</button>
                  </form>
                {% elif ch.status == 'rejected' %}
                  <!-- Restore charity to pending state -->
                  <form method="post" action="{{ url_for('main.admin_verify_charity_action', charity_id=ch.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="restore">
                    <button type="submit" class="btn outline">Restore to pending</button>
                  </form>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <!-- Shown when there are no charities -->
    <div class="flash info">No charities found.</div>
  {% endif %}
</div>

{% endblock %}
<!-- VERSION 2 END -->
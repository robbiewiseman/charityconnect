<!-- VERSION 5 START -->
{% extends "base.html" %}
{% block content %}

<!-- Page header -->
<div class="row space-between" style="align-items:flex-end; gap:16px; margin-bottom:20px">
  <div>
    <h2 style="margin:0 0 6px">My Events</h2>
    <p class="muted" style="margin:0">
      Events published by {{ org.organisation_name or "your organiser account" }}.
    </p>
  </div>
  <div class="row" style="gap:10px">
    <a class="btn outline" href="{{ url_for('main.event_new') }}">Create new event</a>
    <a class="btn" href="{{ url_for('main.events_list') }}">View public events</a>
  </div>
</div>

<!-- Tab navigation -->
<div style="display:flex; gap:4px; border-bottom:2px solid var(--line); margin-bottom:24px;">
  <button class="tab-btn active" onclick="switchTab('active', this)">
    Active Events
    {% if active_events %}
      <span class="tab-count">{{ active_events|length }}</span>
    {% endif %}
  </button>
  <button class="tab-btn" onclick="switchTab('past', this)">
    Past Events
    {% if past_events %}
      <span class="tab-count">{{ past_events|length }}</span>
    {% endif %}
  </button>
  <button class="tab-btn" onclick="switchTab('refunds', this)">
    Refund Requests
    {% if pending_refund_count > 0 %}
      <span class="tab-count" style="background:#dc2626; color:#fff;">{{ pending_refund_count }}</span>
    {% endif %}
  </button>
</div>

<!-- ===== ACTIVE EVENTS TAB ===== -->
<div id="tab-active" class="tab-panel">
  {% if active_events %}
    <div class="events-grid">
      {% for ev in active_events %}
        <div class="card event-card" style="position:relative">
          <div class="event-media"
            data-title="{{ ev.title if not ev.cover_image else '' }}"
            {% if ev.cover_image %}
              style="background-image: url(&quot;{{ url_for('main.event_cover', event_id=ev.id) }}&quot;); background-size:cover; background-position:center;"
            {% endif %}
        ></div>
          <div class="event-body">

            <div class="row space-between" style="align-items:flex-start">
              <h3 class="event-title" style="margin:0">{{ ev.title }}</h3>
              <span class="badge" style="font-weight:700">
                &euro;{{ '%.2f' % (ev.ticket_price_cents/100) }}
              </span>
            </div>

            <div class="event-meta">
              {{ ev.starts_at.strftime('%Y-%m-%d %H:%M') }} &bull; {{ ev.venue or 'TBA' }}
            </div>

            <div class="row" style="gap:8px; margin-top:10px; align-items:center">
              {% if ev.published %}
                <span class="badge verified">Published</span>
              {% else %}
                <span class="badge">Draft</span>
              {% endif %}
              <span class="badge" style="background:#DCFCE7; color:#166534; font-weight:700;">Active</span>
            </div>

            <div style="margin-top:12px">
              <form method="post" action="{{ url_for('main.organiser_event_complete', event_id=ev.id) }}" style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="complete" value="1">
                <button class="btn" type="submit">Mark as completed</button>
              </form>
            </div>

            <div class="event-actions" style="margin-top:12px">
              <a class="btn" href="{{ url_for('main.event_detail', event_id=ev.id) }}">View</a>
              <a class="btn outline" href="{{ url_for('main.organiser_event_edit', event_id=ev.id) }}">Edit</a>
              <a class="btn primary" href="{{ url_for('main.organiser_event_analytics', event_id=ev.id) }}">Analytics</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="card">
      <p class="muted" style="margin:0">No active events. All your events have been completed.</p>
    </div>
  {% endif %}
</div>

<!-- ===== PAST EVENTS TAB ===== -->
<div id="tab-past" class="tab-panel" style="display:none">
  {% if past_events %}
    <div class="events-grid">
      {% for item in past_events %}
        {% set ev = item.event %}
        <div class="card" style="position:relative; background:#F8FAFC;">
          <div style="padding:20px;">

            <div class="row space-between" style="align-items:flex-start; margin-bottom:12px;">
              <div>
                <h3 style="margin:0 0 4px">{{ ev.title }}</h3>
                <p class="muted" style="margin:0; font-size:13px;">
                  {{ ev.starts_at.strftime('%Y-%m-%d') }} &bull; Completed {{ ev.completed_at.strftime('%Y-%m-%d') }}
                </p>
              </div>
              <span class="badge" style="background:#E2E8F0; color:#0F172A; font-weight:700;">Completed</span>
            </div>

            <div style="background:white; border:1px solid #E2E8F0; border-radius:8px; padding:16px; margin-top:12px;">
              <h4 style="margin:0 0 12px; font-size:14px; color:#64748B;">Post-Event Report</h4>
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:16px;">
                <div>
                  <p class="muted" style="margin:0; font-size:12px;">Tickets Sold</p>
                  <p style="margin:0; font-size:20px; font-weight:700;">{{ item.tickets_sold }}</p>
                </div>
                <div>
                  <p class="muted" style="margin:0; font-size:12px;">Total Orders</p>
                  <p style="margin:0; font-size:20px; font-weight:700;">{{ item.orders_count }}</p>
                </div>
                <div>
                  <p class="muted" style="margin:0; font-size:12px;">Total Raised</p>
                  <p style="margin:0; font-size:20px; font-weight:700;">&euro;{{ '%.2f' % (item.total_raised_cents / 100) }}</p>
                </div>
                <div>
                  <p class="muted" style="margin:0; font-size:12px;">Total Donations</p>
                  <p style="margin:0; font-size:20px; font-weight:700;">&euro;{{ '%.2f' % (item.donation_cents / 100) }}</p>
                </div>
              </div>
              {% if item.allocations %}
                <div style="border-top:1px solid #E2E8F0; padding-top:12px;">
                  <p style="margin:0 0 8px; font-size:13px; font-weight:600;">Beneficiary Allocations</p>
                  {% for alloc in item.allocations %}
                    <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                      <span style="font-size:13px;">{{ alloc.charity_name }}</span>
                      <span style="font-size:13px; font-weight:600;">{{ alloc.percent }}% = &euro;{{ '%.2f' % (alloc.estimated_cents / 100) }}</span>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap;">
              <a class="btn outline" href="{{ url_for('main.event_detail', event_id=ev.id) }}">View Event</a>
              <a class="btn" href="{{ url_for('main.organiser_event_analytics', event_id=ev.id) }}">Full Analytics</a>
              <form method="post" action="{{ url_for('main.organiser_event_complete', event_id=ev.id) }}" style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="complete" value="0">
                <button class="btn outline" type="submit">Reopen Event</button>
              </form>
            </div>

          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="card">
      <p class="muted" style="margin:0">No completed events yet.</p>
    </div>
  {% endif %}
</div>

<!-- ===== REFUND REQUESTS TAB ===== -->
<div id="tab-refunds" class="tab-panel" style="display:none">
  <p class="muted" style="margin:0 0 16px;">Review and respond to refund requests from your attendees.</p>

  {% if refund_requests %}
    <div style="display:flex; flex-direction:column; gap:16px;">
      {% for req in refund_requests %}
        <div class="card">
          <div class="row space-between" style="align-items:flex-start; flex-wrap:wrap; gap:12px;">

            <div>
              <h3 style="margin:0 0 4px;">{{ req.order.event.title }}</h3>
              <p class="muted" style="margin:0; font-size:13px;">
                Order #{{ req.order.id }} &bull; {{ req.order.email }} &bull;
                &euro;{{ '%.2f' % (req.order.total_cents / 100) }} &bull;
                Requested {{ req.requested_at.strftime('%d %b %Y %H:%M') }}
              </p>
              {% if req.reason %}
                <p style="margin:8px 0 0; font-size:13px;"><strong>Reason:</strong> {{ req.reason }}</p>
              {% else %}
                <p class="muted" style="margin:8px 0 0; font-size:13px;">No reason provided.</p>
              {% endif %}
            </div>

            <div>
              {% if req.status == 'PENDING' %}
                <span class="badge" style="background:#FEF9C3; color:#854D0E;">Pending</span>
              {% elif req.status == 'APPROVED' %}
                <span class="badge" style="background:#DCFCE7; color:#166534;">Approved</span>
              {% elif req.status == 'DENIED' %}
                <span class="badge" style="background:#FEE2E2; color:#991B1B;">Denied</span>
              {% endif %}
            </div>

          </div>

          {% if req.status == 'PENDING' %}
            <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--line);">
              <form method="post" action="{{ url_for('main.organiser_resolve_refund', req_id=req.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label style="font-size:13px; font-weight:600;">Message to user (optional)</label>
                <textarea name="organiser_note" rows="2"
                          placeholder="e.g. Refund processed to your card within 5-10 days..."
                          style="width:100%; box-sizing:border-box; margin:6px 0 12px;"></textarea>
                <div class="row" style="gap:8px;">
                  <button type="submit" name="decision" value="approve" class="btn success">
                    Approve Refund
                  </button>
                  <button type="submit" name="decision" value="deny" class="btn danger-outline"
                          onclick="return confirm('Deny this refund request?')">
                    Deny Refund
                  </button>
                </div>
              </form>
            </div>
          {% else %}
            <div style="margin-top:12px; font-size:13px; color:var(--muted);">
              Resolved on {{ req.resolved_at.strftime('%d %b %Y %H:%M') }}.
              {% if req.organiser_note %}
                Note: &ldquo;{{ req.organiser_note }}&rdquo;
              {% endif %}
            </div>
          {% endif %}

        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="card">
      <p class="muted" style="margin:0;">No refund requests yet.</p>
    </div>
  {% endif %}
</div>

<!-- Tab styles -->
<style>
.tab-btn {
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  padding: 10px 16px;
  margin-bottom: -2px;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--muted);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: color .15s ease, border-color .15s ease;
  font-family: inherit;
}
.tab-btn:hover { color: var(--text-0); }
.tab-btn.active {
  color: var(--brand-primary);
  border-bottom-color: var(--brand-primary);
}
.tab-count {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  border-radius: 999px;
  background: #e2e8f0;
  color: #0f172a;
  font-size: 0.75rem;
  font-weight: 700;
}
</style>

<script>
function switchTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).style.display = 'block';
  btn.classList.add('active');
}
// Auto-open refunds tab if redirected back after resolving
if (window.location.hash === '#refunds') {
  switchTab('refunds', document.querySelectorAll('.tab-btn')[2]);
}
</script>

{% endblock %}
<!-- VERSION 5 END -->
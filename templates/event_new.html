<!-- Version 1 -->

{% extends "base.html" %}
{% block content %}

<!-- Organiser: Create Event -->
<div class="row" style="align-items:flex-start; gap:18px">
  <!-- LEFT COLUMN: Main event creation form -->
  <div class="grow">
    <div class="card" style="padding-bottom:10px">
      <h2 style="margin:0 0 6px">Create a New Event</h2>
      <p class="muted" style="margin:0 0 12px">Add the key details, ticket price, and how funds are allocated.</p>

      <!-- Flask-WTF form (CSRF included via hidden_tag) -->
      <!-- Reference: Flask-WTF form rendering, CSRF, and hidden_tag (Pallets Projects, 2024)
      https://flask-wtf.readthedocs.io/en/1.2.x/quickstart/
      https://flask-wtf.readthedocs.io/en/1.2.x/form/
      https://flask-wtf.readthedocs.io/en/1.2.x/csrf/ -->
      <form method="post" novalidate>
        {{ form.hidden_tag() }}

        <!-- Selection: Event basics -->
        <h3 style="margin:6px 0 8px">Event Details</h3>

        <!-- Title -->
        <label for="{{ form.title.id }}">Title</label>
        {{ form.title(class="", placeholder="e.g. Cork Christmas Fundraiser") }}
        {% for e in form.title.errors %}<div class="flash danger">{{ e }}</div>{% endfor %}

        <!-- Description -->
        <label for="{{ form.description.id }}">Description</label>
        {{ form.description(class="", rows="4", placeholder="What’s the event about?") }}
        {% for e in form.description.errors %}<div class="flash danger">{{ e }}</div>{% endfor %}

        <!-- Venue + Start datetime -->
        <div class="row" style="gap:12px; margin-top:8px">
          <div style="flex:1">
            <label for="{{ form.venue.id }}">Venue</label>
            {{ form.venue(class="", placeholder="e.g. City Hall, Cork") }}
            {% for e in form.venue.errors %}<div class="flash danger">{{ e }}</div>{% endfor %}
          </div>
          <div style="flex:1">
            <label for="{{ form.starts_at.id }}">Starts At</label>
            <!-- Uses HTML5 datetime-local; server will parse/validate -->
            <!-- Reference: HTML input type "datetime-local" (MDN, 2024)
            https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/datetime-local -->
            {{ form.starts_at(class="", type="datetime-local") }}
            {% for e in form.starts_at.errors %}<div class="flash danger">{{ e }}</div>{% endfor %}
          </div>
        </div>

        <!-- Price + Publish toggle -->
        <div class="row" style="gap:12px; margin-top:8px">
          <div style="flex:1">
            <label for="{{ form.ticket_price_eur.id }}">Ticket Price (€)</label>
            {{ form.ticket_price_eur(class="", placeholder="e.g. 15.00") }}
            {% for e in form.ticket_price_eur.errors %}<div class="flash danger">{{ e }}</div>{% endfor %}
          </div>
          <!-- Simple publish-now checkbox (server decides draft vs published) -->
          <div style="flex:1; display:flex; align-items:end">
            <label class="row" style="gap:10px; align-items:center; margin:0">
              <span>Publish immediately?</span>
              {{ form.published(class="") }}
            </label>
          </div>
        </div>

        <hr style="margin:16px 0; border:none; border-top:1px solid var(--line)">

        <!-- Section: Beneficiaries & Allocations -->
        <div class="row space-between" style="align-items:center">
          <h3 style="margin:0">Beneficiaries</h3>
          <div class="row" style="gap:10px; align-items:center">
            <!-- Reminder: validation rule (sum must be 100%) -->
            <span class="badge" style="font-weight:700">Total must equal 100%</span>
            <!-- “Add Beneficiary” submits form without validation to append another subform row. The view should detect 'add_beneficiary' and re-render with an extra entry. -->
             <!-- Reference: HTML form attribute 'formnovalidate' (MDN, 2024)
            https://developer.mozilla.org/en-US/docs/Web/HTML/Element/button#attr-formnovalidate -->
            <button class="btn outline" name="add_beneficiary" value="1" formnovalidate type="submit">+ Add Beneficiary</button>
          </div>
        </div>
        <p class="muted" style="margin:6px 0 12px">
          Allocations must add up to <strong>100%</strong>. The system will validate this when you submit.
        </p>

        <!-- FieldList of beneficiary subforms: charity selector + % allocation -->
        <!-- Reference: Jinja for-loop & form field rendering (Pallets Projects, 2024; WTForms, 2024)
        https://jinja.palletsprojects.com/en/stable/templates/#for
        https://wtforms.readthedocs.io/en/stable/crash_course/#rendering-fields -->
        <div class="vstack" style="display:flex; flex-direction:column; gap:10px">
          {% for b in form.beneficiaries %}
            <div class="row" style="gap:12px; border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:#fff">
              <div class="grow">
                <label for="{{ b.charity_id.id }}">Charity</label>
                {{ b.charity_id(class="") }}
                {% for e in b.charity_id.errors %}<div class="flash danger">{{ e }}</div>{% endfor %}
              </div>
              <div style="width:160px">
                <label for="{{ b.allocation_percent.id }}">% Allocation</label>
                {{ b.allocation_percent(class="", placeholder="e.g. 50") }}
                {% for e in b.allocation_percent.errors %}<div class="flash danger">{{ e }}</div>{% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Global form errors (e.g., CSRF issues; allocation sum != 100 handled in view/form validators) -->
        <!-- Reference: Flask-WTF CSRF error reporting (Pallets Projects, 2024)
        https://flask-wtf.readthedocs.io/en/1.2.x/csrf/ -->
        {% if form.csrf_token.errors %}
          {% for e in form.csrf_token.errors %}<div class="flash danger">{{ e }}</div>{% endfor %}
        {% endif %}

        <!-- Actions: Cancel or Submit (server will create draft/published based on checkbox) -->
        <div class="row" style="justify-content:flex-end; gap:10px; margin-top:16px">
          <!-- Reference: Flask url_for (Pallets Projects, 2024)
          https://flask.palletsprojects.com/en/stable/quickstart/#url-building -->
          <a class="btn" href="{{ url_for('main.index') }}">Cancel</a>
          {{ form.submit(class="btn primary") }}
        </div>
      </form>
    </div>
  </div>

  <!-- RIGHT COLUMN: Static preview/tips -->
  <aside style="width:340px; max-width:100%">
    <div class="card ticket">
      <div class="row space-between">
        <strong>Event Preview</strong>
        <span class="badge">Draft</span>
      </div>
      <!-- Lightweight, read-only hints reflecting current inputs where possible -->
      <div style="margin-top:10px">
        <!-- Ticket price preview (falls back to €0.00 if empty) -->
        <div class="row space-between">
          <span>Ticket price</span>
          <!-- Show current input value if bound back by WTForms after POST, else placeholder -->
          <strong>
            {% if form.ticket_price_eur.data %}
              €{{ '%.2f' % (form.ticket_price_eur.data | float) }}
            {% else %}
              €0.00
            {% endif %}
          </strong>
        </div>

         <!-- Allocation total: not calculated here (no JS); enforced on submit -->
        <div class="row space-between" style="margin-top:6px">
          <span>Allocation total</span>
          <strong>—</strong>
        </div>
      </div>
      <hr style="margin:12px 0; border:none; border-top:1px solid var(--line)">
      <!-- Authoring tip for organisers -->
      <div class="muted" style="font-size:.9rem">
        Tip: keep descriptions short (2–4 lines), and add a clear venue + start time.
        You can publish now or save as draft.
      </div>
    </div>
  </aside>
</div>

{% endblock %}

<!-- Version 1 -->
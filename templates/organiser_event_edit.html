<!-- VERSION 3 START -->
{% extends "base.html" %}
{% block content %}

<!-- Page header: title + quick links -->
<div class="row space-between" style="align-items:flex-end; gap:16px; margin-bottom:12px">
  <div>
    <h2 style="margin:0 0 6px">Edit Event</h2> <!-- Page title -->
    <p class="muted" style="margin:0">Update details and allocations for: <strong>{{ ev.title }}</strong> <!-- Context for the organiser -->
    </p> 
  </div>
  <!-- Navigation buttons -->
  <div class="row" style="gap:10px">
    <a class="btn" href="{{ url_for('main.organiser_events') }}">Back to My Events</a> <!-- Return to organiser list -->
    <a class="btn outline" href="{{ url_for('main.organiser_event_analytics', event_id=ev.id) }}">View Analytics</a> <!-- Jump to analytics -->
  </div>
</div>

<!-- Main form card -->
<div class="card">
  <!-- VERSION 5 START -->
  <form method="post" novalidate enctype="multipart/form-data">
  <!-- VERSION 5 START -->
    {{ form.hidden_tag() }} <!-- CSRF token + hidden fields -->

    <h3 style="margin:0 0 8px">Event Details</h3> <!-- Section heading -->

    <!-- Title field -->
    <label for="{{ form.title.id }}">Title</label>
    {{ form.title(class="") }}
    {% for e in form.title.errors %} <!-- Show title validation errors -->
      <div class="flash danger">{{ e }}</div>
    {% endfor %}

    <!-- Description field -->
    <label for="{{ form.description.id }}">Description</label>
    {{ form.description(class="", rows="4") }}

    <!-- AI description helper -->
    <div class="row" style="gap:10px; margin-top:8px">
      <button type="button" class="btn outline" id="btn-ai-desc">
        Suggest description
      </button>
      <span class="muted" id="ai-status" style="align-self:center"></span>
    </div>

    {% for e in form.description.errors %} <!-- Show description validation errors -->
      <div class="flash danger">{{ e }}</div>
    {% endfor %}

    <!-- Venue + date/time row -->
    <div class="row" style="gap:12px; margin-top:8px">
      <div style="flex:1">
        <label for="{{ form.venue.id }}">Venue</label>
        {{ form.venue(class="") }}
        {% for e in form.venue.errors %} <!-- Show venue validation errors -->
          <div class="flash danger">{{ e }}</div>
        {% endfor %}
      </div>

      <div style="flex:1">
        <label for="{{ form.starts_at.id }}">Starts At</label>
        {{ form.starts_at(class="", type="datetime-local") }} <!-- HTML datetime picker -->
        {% for e in form.starts_at.errors %} <!-- Show start time validation errors -->
          <div class="flash danger">{{ e }}</div>
        {% endfor %}
      </div>
    </div>

    <!-- Ticket price + published toggle row -->
    <div class="row" style="gap:12px; margin-top:8px">
      <div style="flex:1">
        <label for="{{ form.ticket_price_eur.id }}">Ticket Price (€)</label>
        {{ form.ticket_price_eur(class="") }}
        {% for e in form.ticket_price_eur.errors %} <!-- Show price validation errors -->
          <div class="flash danger">{{ e }}</div>
        {% endfor %}
      </div>

      <div style="flex:1; display:flex; align-items:end">
        <!-- Published checkbox -->
        <label class="row" style="gap:10px; align-items:center; margin:0">
          <span>Published?</span>
          {{ form.published() }}
        </label>
      </div>
    </div>

    <!-- VERSION 5 START -->
    <label for="{{ form.cover_image.id }}">Event Image (optional)</label>
    {% if ev.cover_image %}
      <div style="margin-bottom:10px;">
        <img src="{{ url_for('main.event_cover', event_id=ev.id) }}" 
          style="height:80px; border-radius:8px; object-fit:cover; display:block; margin-bottom:8px;">
        <label class="row" style="gap:8px; align-items:center; margin:0; cursor:pointer;">
          <input type="checkbox" name="remove_cover_image" value="1">
          <span style="font-size:.9rem; color:#dc2626; font-weight:600;">Remove current image</span>
        </label>
        <p class="muted" style="margin:4px 0 8px; font-size:.85rem;">
          Or upload a new one below to replace it.
        </p>
      </div>
    {% else %}
      <p class="muted" style="margin:-4px 0 8px; font-size:.85rem;">
        Upload a JPG or PNG. If left blank, a branded banner will be shown.
      </p>
    {% endif %}
    {{ form.cover_image(class="") }}
    {% for e in form.cover_image.errors %}
      <div class="flash danger">{{ e }}</div>
    {% endfor %}
    <!-- VERSION 5 END -->

    <!-- Divider between sections -->
    <hr style="margin:16px 0; border:none; border-top:1px solid var(--line)">

    <!-- Beneficiaries header + add button -->
    <div class="row space-between" style="align-items:center">
      <h3 style="margin:0">Beneficiaries</h3> <!-- Section heading -->

      <div class="row" style="gap:10px; align-items:center">
        <span class="badge" style="font-weight:700">Total must equal 100%</span> <!-- Reminder -->
        <button class="btn outline" name="add_beneficiary" value="1" formnovalidate type="submit">+ Add Beneficiary</button>
      </div>
    </div>

    <!-- Beneficiary rows -->
    <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
      {% for b in form.beneficiaries %} <!-- Loop each beneficiary subform -->
        <div class="row" style="gap:12px; border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:#fff">
          <div class="grow">
            <label>Charity</label>
            {{ b.charity_id(class="") }} <!-- Charity dropdown -->
            {% for e in b.charity_id.errors %} <!-- Charity dropdown validation errors -->
              <div class="flash danger">{{ e }}</div>
            {% endfor %}
          </div>

          <div style="width:160px">
            <label>% Allocation</label>
            {{ b.allocation_percent(class="") }} <!-- Allocation input -->
            {% for e in b.allocation_percent.errors %} <!-- Allocation validation errors -->
              <div class="flash danger">{{ e }}</div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Form actions -->
    <div class="row" style="justify-content:flex-end; gap:10px; margin-top:16px">
      <a class="btn" href="{{ url_for('main.organiser_events') }}">Cancel</a> <!-- Discard changes -->
      {{ form.submit(class="btn primary", value="Save Changes") }} <!-- Submit updates -->
    </div>
  </form>
</div>

<!-- Reference: ChatGPT JavaScript code -->
<!-- https://chatgpt.com/share/69736e29-4d08-8004-a8ff-71f40f533a51 -->
<script>
// Read the CSRF token from the meta tag so POST requests are accepted by Flask
  const csrfToken = document
    .querySelector('meta[name="csrf-token"]')
    .getAttribute('content');

// Collect all relevant form values to send to the AI endpoint
  function collectPayload() {
    // Basic event fields
    const title = document.querySelector('input[name="title"]')?.value || "";
    const venue = document.querySelector('input[name="venue"]')?.value || "";
    const starts_at = document.querySelector('input[name="starts_at"]')?.value || "";
    const ticket_price = document.querySelector('input[name="ticket_price_eur"]')?.value || "";

    // Select all beneficiary dropdowns and percentage inputs
    const benSelects = document.querySelectorAll('select[name^="beneficiaries-"][name$="-charity_id"]');
    const benPcts = document.querySelectorAll('input[name^="beneficiaries-"][name$="-allocation_percent"]');

    // Build an array of beneficiary names and allocation percentages
    const beneficiaries = [];
    for (let i = 0; i < benSelects.length; i++) {
      const name = benSelects[i]?.selectedOptions?.[0]?.text || "";
      const pct = benPcts[i]?.value ? parseInt(benPcts[i].value, 10) : null;
      if (name) beneficiaries.push({ name, pct });
    }

    // Return the payload object expected by the Flask AI route
    return { title, venue, starts_at, ticket_price, beneficiaries };
  }

  // Call the AI endpoint and optionally fill the description textarea
  async function callAI(url, fillDescription=false) {
    const status = document.getElementById('ai-status');
    // Show loading state to the user
    status.textContent = "Thinking…";

    // Send POST request to the AI route
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken
      },
      body: JSON.stringify(collectPayload())
    });

    // Parse the JSON response
    const data = await res.json();

    // Handle error response from the server or AI
    if (!data.ok) {
      status.textContent = "Error";
      out.textContent = data.error || "Something went wrong.";
      return;
    }

    // Update status once AI processing is complete
    status.textContent = "Done";

    // Insert the AI-generated text into the description field
    const ta = document.querySelector('textarea[name="description"]');
    if (ta && data.text) ta.value = data.text.trim();
  }

  // Trigger AI description generation when the button is clicked
  document
  .getElementById('btn-ai-desc')
  .addEventListener('click', () => {
    callAI("{{ url_for('main.ai_event_description') }}", true);
  });
</script>

{% endblock %}
<!-- VERSION 3 END -->